/*------------------------------------------------------------------------*
 *                         AUTOCORR.C                                     *
 *------------------------------------------------------------------------*
 *   Compute autocorrelations of signal with windowing                    *
 *                                                                        *
 *------------------------------------------------------------------------*/

#include "amrwb_acelp.h"
#include "amrwb_cnst.h"

/*#define L_WINDOW 384*/

Word16 window[AMRWB_L_WINDOW] = {
    2621,    2622,    2626,    2632,    2640,    2650,    2662,    2677,
    2694,    2714,    2735,    2759,    2785,    2814,    2844,    2877,
    2912,    2949,    2989,    3031,    3075,    3121,    3169,    3220,
    3273,    3328,    3385,    3444,    3506,    3569,    3635,    3703,
    3773,    3845,    3919,    3996,    4074,    4155,    4237,    4321,
    4408,    4496,    4587,    4680,    4774,    4870,    4969,    5069,
    5171,    5275,    5381,    5489,    5599,    5710,    5824,    5939,
    6056,    6174,    6295,    6417,    6541,    6666,    6793,    6922,
    7052,    7185,    7318,    7453,    7590,    7728,    7868,    8009,
    8152,    8296,    8442,    8589,    8737,    8887,    9038,    9191,
    9344,    9499,    9655,    9813,    9971,   10131,   10292,   10454,
   10617,   10781,   10946,   11113,   11280,   11448,   11617,   11787,
   11958,   12130,   12303,   12476,   12650,   12825,   13001,   13178,
   13355,   13533,   13711,   13890,   14070,   14250,   14431,   14612,
   14793,   14975,   15158,   15341,   15524,   15708,   15891,   16076,
   16260,   16445,   16629,   16814,   16999,   17185,   17370,   17555,
   17740,   17926,   18111,   18296,   18481,   18666,   18851,   19036,
   19221,   19405,   19589,   19773,   19956,   20139,   20322,   20504,
   20686,   20867,   21048,   21229,   21408,   21588,   21767,   21945,
   22122,   22299,   22475,   22651,   22825,   22999,   23172,   23344,
   23516,   23686,   23856,   24025,   24192,   24359,   24525,   24689,
   24853,   25016,   25177,   25337,   25496,   25654,   25811,   25967,
   26121,   26274,   26426,   26576,   26725,   26873,   27019,   27164,
   27308,   27450,   27590,   27729,   27867,   28003,   28137,   28270,
   28401,   28531,   28659,   28785,   28910,   29033,   29154,   29274,
   29391,   29507,   29622,   29734,   29845,   29953,   30060,   30165,
   30268,   30370,   30469,   30566,   30662,   30755,   30847,   30936,
   31024,   31109,   31193,   31274,   31354,   31431,   31506,   31579,
   31651,   31719,   31786,   31851,   31914,   31974,   32032,   32088,
   32142,   32194,   32243,   32291,   32336,   32379,   32419,   32458,
   32494,   32528,   32560,   32589,   32617,   32642,   32664,   32685,
   32703,   32719,   32733,   32744,   32753,   32760,   32764,   32767,
   32767,   32765,   32757,   32745,   32727,   32705,   32678,   32646,
   32609,   32567,   32520,   32468,   32411,   32349,   32283,   32211,
   32135,   32054,   31968,   31877,   31781,   31681,   31575,   31465,
   31351,   31231,   31107,   30978,   30844,   30706,   30563,   30415,
   30263,   30106,   29945,   29779,   29609,   29434,   29255,   29071,
   28883,   28691,   28494,   28293,   28087,   27878,   27664,   27446,
   27224,   26997,   26767,   26533,   26294,   26052,   25806,   25555,
   25301,   25043,   24782,   24516,   24247,   23974,   23698,   23418,
   23134,   22847,   22557,   22263,   21965,   21665,   21361,   21054,
   20743,   20430,   20113,   19794,   19471,   19146,   18817,   18486,
   18152,   17815,   17476,   17134,   16789,   16442,   16092,   15740,
   15385,   15028,   14669,   14308,   13944,   13579,   13211,   12841,
   12470,   12096,   11721,   11344,   10965,   10584,   10202,    9819,
    9433,    9047,    8659,    8270,    7879,    7488,    7095,    6701,
    6306,    5910,    5514,    5116,    4718,    4319,    3919,    3519,
    3118,    2716,    2315,    1913,    1510,    1108,     705,     302};

void AMRWB_Autocorr(
     Word16 x[],                           /* (i)    : Input signal                      */
     Word16 m,                             /* (i)    : LPC order                         */
     Word16 r_h[],                         /* (o) Q15: Autocorrelations  (msb)           */
     Word16 r_l[]                          /* (o)    : Autocorrelations  (lsb)           */
)
{
    Word16 norm, shift;
    Word32 y32[AMRWB_L_WINDOW/2];
    Word16 *y = (Word16 *)y32;
    Word32 i, L_sum, L_tmp;

    /* Windowing of signal */

    /*for (i = 0; i < L_WINDOW; i++)
    {
        y[i] = mult_r(x[i], window[i]);
    }*/
    CODEC_OpVvMultR(x, window, AMRWB_L_WINDOW, y);

    /* calculate energy of signal */

    L_sum = L_deposit_h(16);               /* sqrt(256), avoid overflow after rounding */
    for (i = 0; i < AMRWB_L_WINDOW; i++)
    {
        L_tmp = L_mult(y[i], y[i]);
        L_tmp = L_shr(L_tmp, 8);
        L_sum = L_add(L_sum, L_tmp);
    }

    /* scale signal to avoid overflow in autocorrelation */

    norm = norm_l(L_sum);
    shift = sub(4, shr(norm, 1));

    if (shift < 0)
    {
        shift = 0;
    }

    /*for (i = 0; i < L_WINDOW; i++)
    {
        y[i] = shr_r(y[i], shift);
    }*/
    CODEC_OpVecShr_r(y, AMRWB_L_WINDOW, shift, y);

    /* Compute and normalize r[0] */

    L_sum = 1;
    /*for (i = 0; i < L_WINDOW; i++)
        L_sum = L_mac(L_sum, y[i], y[i]);*/
    L_sum = CODEC_OpVvSelfMacAlignedQuan(y, AMRWB_L_WINDOW, L_sum);

    norm = norm_l(L_sum);
    L_sum = L_shl(L_sum, norm);
    L_Extract(L_sum, &r_h[0], &r_l[0]);    /* Put in DPF format (see oper_32b) */

    /* Compute r[1] to r[m] */

    for (i = 1; i <= m; i+=2)
    {
        L_sum = 0;

        /*for (j = 0; j < L_WINDOW - i; j++)
            L_sum = L_mac(L_sum, y[j], y[j + i]);*/
        L_sum = CODEC_OpVvMacAlignless(y, &y[i], AMRWB_L_WINDOW - i, L_sum);

        L_sum = L_shl(L_sum, norm);
        L_Extract(L_sum, &r_h[i], &r_l[i]);
    }

    for (i = 2; i <= m; i+=2)
    {
        L_sum = 0;

        /*for (j = 0; j < L_WINDOW - i; j++)
            L_sum = L_mac(L_sum, y[j], y[j + i]);*/
        L_sum = CODEC_OpVvMacAlignedEven(y, &y[i], AMRWB_L_WINDOW - i, L_sum);

        L_sum = L_shl(L_sum, norm);
        L_Extract(L_sum, &r_h[i], &r_l[i]);
    }


    return;
}
